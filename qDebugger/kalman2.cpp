#include "kalman2.h"

struct KALMAN2 kalman2[2];

void Kalman2_init(struct KALMAN2 *kalman) {

    kalman->Ptheta = 0.01;
    kalman->Pomega = 0.01;
    kalman->Pbias = 0.01;
    kalman->PsensorTheta = 0.01;
    kalman->PsensorOmega = 0.01;

    kalman->P[0][0] = kalman->Ptheta;
    kalman->P[1][1] = kalman->Pomega;
    kalman->P[2][2] = kalman->Pbias;

    // varianzas cruzados igual a 0
    kalman->P[0][1] = 0;
    kalman->P[0][2] = 0;
    kalman->P[1][0] = 0;
    kalman->P[1][2] = 0;
    kalman->P[2][0] = 0;
    kalman->P[2][1] = 0;


    kalman->x[0]=0;
    kalman->x[1]=0;
    kalman->x[2]=0;

    kalman->h=1;

}

float Kalman2(struct KALMAN2 *kalman, float motor, float theta, float omega) {
    float x_new[3];

    kalman->J[0][0] = ((kalman->P[0][0] + kalman->P[1][0]*kalman->h)*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[3][3]*kalman->PsensorTheta - kalman->P[3][2]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][0] - kalman->P[2][0])*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta);
    kalman->J[0][1] = ((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][1] - kalman->P[0][2])*(kalman->P[0][0] + kalman->P[1][0]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta);
    kalman->J[1][0] = (kalman->P[1][0]*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][1] - kalman->P[1][2])*(kalman->P[1][0] - kalman->P[2][0]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta);
    kalman->J[1][1] = ((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[1][1] - kalman->P[1][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[1][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta);
    kalman->J[2][0] = (kalman->P[2][0]*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][0] - kalman->P[2][0])*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta);
    kalman->J[2][1] = ((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[2][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta);

    kalman->P[0][0] = kalman->P[0][0] + kalman->Ptheta + kalman->P[1][0]*kalman->h + kalman->h*(kalman->P[0][1] + kalman->P[1][1]*kalman->h) + kalman->P[0][0]*(((kalman->P[1][0] - kalman->P[2][0])*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->P[1][0]*kalman->h)*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->h*(kalman->P[0][1]*(((kalman->P[1][0] - kalman->P[2][0])*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->P[1][0]*kalman->h)*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[1][1]*(((kalman->P[0][1] - kalman->P[0][2])*(kalman->P[0][0] + kalman->P[1][0]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) - kalman->P[2][1]*(((kalman->P[0][1] - kalman->P[0][2])*(kalman->P[0][0] + kalman->P[1][0]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta))) + kalman->P[1][0]*(((kalman->P[0][1] - kalman->P[0][2])*(kalman->P[0][0] + kalman->P[1][0]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) - kalman->P[2][0]*(((kalman->P[0][1] - kalman->P[0][2])*(kalman->P[0][0] + kalman->P[1][0]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta));
    kalman->P[0][1] = kalman->P[0][1] + kalman->P[1][1]*kalman->h + kalman->P[0][1]*(((kalman->P[1][0] - kalman->P[2][0])*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->P[1][0]*kalman->h)*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[1][1]*(((kalman->P[0][1] - kalman->P[0][2])*(kalman->P[0][0] + kalman->P[1][0]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) - kalman->P[2][1]*(((kalman->P[0][1] - kalman->P[0][2])*(kalman->P[0][0] + kalman->P[1][0]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta));
    kalman->P[0][2] = kalman->P[0][2] + kalman->P[1][2]*kalman->h + kalman->P[0][2]*(((kalman->P[1][0] - kalman->P[2][0])*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->P[1][0]*kalman->h)*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[1][2]*(((kalman->P[0][1] - kalman->P[0][2])*(kalman->P[0][0] + kalman->P[1][0]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) - kalman->P[2][2]*(((kalman->P[0][1] - kalman->P[0][2])*(kalman->P[0][0] + kalman->P[1][0]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta));
    kalman->P[1][0] = kalman->P[1][0] - kalman->P[0][0]*((kalman->P[1][0]*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][1] - kalman->P[1][2])*(kalman->P[1][0] - kalman->P[2][0]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[1][1]*kalman->h - kalman->P[1][0]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[1][1] - kalman->P[1][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[1][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[2][0]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[1][1] - kalman->P[1][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[1][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) - kalman->h*(kalman->P[0][1]*((kalman->P[1][0]*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][1] - kalman->P[1][2])*(kalman->P[1][0] - kalman->P[2][0]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[1][1]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[1][1] - kalman->P[1][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[1][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) - kalman->P[2][1]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[1][1] - kalman->P[1][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[1][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)));
    kalman->P[1][1] = kalman->P[1][1] + kalman->Pomega - kalman->P[0][1]*((kalman->P[1][0]*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][1] - kalman->P[1][2])*(kalman->P[1][0] - kalman->P[2][0]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) - kalman->P[1][1]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[1][1] - kalman->P[1][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[1][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[2][1]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[1][1] - kalman->P[1][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[1][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta));
    kalman->P[1][2] = kalman->P[1][2] - kalman->P[0][2]*((kalman->P[1][0]*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][1] - kalman->P[1][2])*(kalman->P[1][0] - kalman->P[2][0]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) - kalman->P[1][2]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[1][1] - kalman->P[1][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[1][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[2][2]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[1][1] - kalman->P[1][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[1][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta));
    kalman->P[2][0] = kalman->P[2][0] - kalman->P[0][0]*((kalman->P[2][0]*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][0] - kalman->P[2][0])*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[2][1]*kalman->h - kalman->P[1][0]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[2][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[2][0]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[2][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) - kalman->h*(kalman->P[0][1]*((kalman->P[2][0]*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][0] - kalman->P[2][0])*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[1][1]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[2][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) - kalman->P[2][1]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[2][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)));
    kalman->P[2][1] = kalman->P[2][1] - kalman->P[0][1]*((kalman->P[2][0]*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][0] - kalman->P[2][0])*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) - kalman->P[1][1]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[2][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[2][1]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[2][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta));
    kalman->P[2][2] = kalman->P[2][2] + kalman->Pbias - kalman->P[0][2]*((kalman->P[2][0]*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][0] - kalman->P[2][0])*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) - kalman->P[1][2]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[2][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->P[2][2]*(((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[2][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta));


    x_new[0] = kalman->x[0] + (kalman->x[0] - theta)*(((kalman->P[1][0] - kalman->P[2][0])*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->P[1][0]*kalman->h)*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta)) + kalman->h*kalman->x[1] + ((kalman->h*kalman->h)*motor)/2 - (((kalman->P[0][1] - kalman->P[0][2])*(kalman->P[0][0] + kalman->P[1][0]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[0][1] - kalman->P[0][2] + kalman->P[1][1]*kalman->h - kalman->P[1][2]*kalman->h))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta))*(kalman->x[2] - kalman->x[1] + omega);
    x_new[1] = kalman->x[1] + (((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[1][1] - kalman->P[1][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[1][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta))*(kalman->x[2] - kalman->x[1] + omega) + kalman->h*motor - ((kalman->P[1][0]*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][1] - kalman->P[1][2])*(kalman->P[1][0] - kalman->P[2][0]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta))*(kalman->x[0] - theta);
    x_new[2] = kalman->x[2] + (((kalman->P[0][0] + kalman->PsensorTheta)*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - (kalman->P[2][0]*(kalman->P[0][1] - kalman->P[0][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta))*(kalman->x[2] - kalman->x[1] + omega) - ((kalman->P[2][0]*(kalman->P[1][1] - kalman->P[1][2] - kalman->P[2][1] + kalman->P[2][2] + kalman->PsensorOmega))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta) - ((kalman->P[1][0] - kalman->P[2][0])*(kalman->P[2][1] - kalman->P[2][2]))/(kalman->P[2][2]*kalman->PsensorTheta - kalman->P[2][1]*kalman->PsensorTheta + kalman->PsensorOmega*kalman->PsensorTheta + kalman->P[0][0]*kalman->P[1][1] - kalman->P[0][1]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[1][2] + kalman->P[0][2]*kalman->P[1][0] - kalman->P[0][0]*kalman->P[2][1] + kalman->P[0][1]*kalman->P[2][0] + kalman->P[0][0]*kalman->P[2][2] - kalman->P[0][2]*kalman->P[2][0] + kalman->P[0][0]*kalman->PsensorOmega + kalman->P[1][1]*kalman->PsensorTheta - kalman->P[1][2]*kalman->PsensorTheta))*(kalman->x[0] - theta);

    kalman->x[0] = x_new[0];
    kalman->x[1] = x_new[1];
    kalman->x[2] = x_new[2];

    return kalman->x[0];

/*
    J(:,:) = A*P(:,:)*C'*(C*P(:,:)*C'+Pe)^-1;
    P(:,:) = A*P(:,:)*A' - J(:,:)*C*P(:,:)*A' + Pv;
    kalman->x[1](:,:) = A*kalman->x[1](:,:) + B*u(:,:) + J(:,:)*(y(:,:)-C*kalman->x[1](:,:));
*/

}
